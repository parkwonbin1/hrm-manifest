apiVersion: apps/v1
kind: Deployment
metadata:
  name: hrm-php
spec:
  replicas: 1
  template:
    spec:
      containers:				
	- name: php
          env:
            # -----------------------------------------------------------
            # 1. [DB 설정] 읽기는 AWS(Aurora), 쓰기는 온프레미스(VPN)
            # -----------------------------------------------------------
            - name: DB_READ_HOST
              value: "hrm-aurora.cluster-cn4ame8y0oyq.ap-northeast-2.rds.amazonaws.com" # AWS Aurora 엔드포인트
            - name: DB_WRITE_HOST
              value: "172.16.6.141" 
            - name: DB_USER
              value: "admin" 
            - name: DB_NAME
              value: "hrm_db"
            - name: DB_PASS
              valueFrom:
                secretKeyRef:
                  name: hrm-aws-secret
                  key: db-password

            # -----------------------------------------------------------
            # 2. [MinIO 쓰기 설정] 업로드는 무조건 온프레미스로! (VPN)
            # -----------------------------------------------------------
            - name: MINIO_HOST
              value: "172.16.6.91" # [중요] 온프레미스 MinIO IP (VPN)
            - name: MINIO_PORT
              value: "9000"
            - name: MINIO_BUCKET
              value: "hrm-profile"
            - name: MINIO_ACCESS_KEY
              value: "admin"
            - name: MINIO_SECRET_KEY
              value: "admin1234"

            # -----------------------------------------------------------
            # 3. [Hybrid 읽기 전략] AWS 모드 활성화
            #    STORAGE_MODE가 'AWS'면, PHP는 아래 S3 URL을 이미지 주소로 사용함
            # -----------------------------------------------------------
            - name: STORAGE_MODE
              value: "AWS"
            
            # S3 버킷의 웹 접속 URL (버킷명 + 리전 + 경로)
            # 'https://'는 PHP 코드에서 붙여주므로 뺍니다 (minio.php 로직 확인 必)
            # 만약 minio.php에 "https://" . getenv(...) 로 되어있다면 아래처럼 도메인만 입력
            - name: AWS_S3_BUCKET_URL
              value: "hrm-bucket-soldesk.s3.ap-northeast-2.amazonaws.com/hrm-profile"

            # AWS SDK용 인증 정보 (혹시 S3 직접 접근 시 필요할 수 있음)
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: hrm-aws-secret
                  key: aws-access-key
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: hrm-aws-secret
                  key: aws-secret-key
            - name: AWS_DEFAULT_REGION
              value: "ap-northeast-2"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hrm-nginx
spec:
  replicas: 1
