#-------------------
# 1. PHP Backend
# -------------------
apiVersion: v1
kind: Service
metadata:
  name: php-service
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  ports:
    - port: 9000
  selector:
    app: hrm-php
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hrm-php
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: hrm-php
  template:
    metadata:
      labels:
        app: hrm-php
    spec:
      imagePullSecrets:
        - name: regcred
      containers:
        - name: php
          livenessProbe:
            tcpSocket:
              port: 9000     # PHP-FPM 포트가 아니라 Nginx를 통한다면 8080, 직통이면 설정 복잡함.
                             # 보통 PHP 파드는 TCP 소켓 체크를 하거나, 
                             # exec command로 체크하는 게 더 확실해.
            initialDelaySeconds: 10
            periodSeconds: 10
          image: 789351387140.dkr.ecr.ap-northeast-2.amazonaws.com/hrm-project/php:latest
          imagePullPolicy: Always
          env:
            - name: DB_PORT
              value: "3306"
            - name: CLUSTER_ENV
              value: "ONPREM"
            - name: DB_READ_HOST
              value: "mariadb-service"  # K8s 내부 서비스명
            - name: DB_WRITE_HOST
              value: "mariadb-service"
            - name: DB_USER
              value: "admin"
            - name: DB_PASS
              value: "soldesk1."
            - name: DB_NAME
              value: "hrm_db"
            - name: MINIO_HOST
              value: "minio-service"    # K8s 내부 서비스명
            - name: MINIO_PORT
              value: "9000"
            - name: MINIO_BUCKET
              value: "hrm-bucket-soldesk"
            - name: MINIO_ACCESS_KEY
              value: "admin"
            - name: MINIO_SECRET_KEY
              value: "admin1234"
            - name: STORAGE_MODE
              value: "ONPREM"
            - name: MINIO_PUBLIC_URL
              value: "http://172.16.6.91:9000"

            - name: AWS_S3_BUCKET_URL
              value: ""
---
# -------------------
# 2. Nginx Frontend
# -------------------
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  ports:
    - port: 8080
  selector:
    app: hrm-nginx
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hrm-nginx
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: hrm-nginx
  template:
    metadata:
      labels:
        app: hrm-nginx
    spec:
      imagePullSecrets:
        - name: regcred
      containers:
        - name: nginx
          livenessProbe:
            httpGet:
              path: /health.php  
              port: 8080
            initialDelaySeconds: 15
            periodSeconds: 10
          
          readinessProbe:
            httpGet:
              path: /health.php
              port: 8080
            initialDelaySeconds: 15
            periodSeconds: 10
          image: 789351387140.dkr.ecr.ap-northeast-2.amazonaws.com/hrm-project/nginx:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8080
